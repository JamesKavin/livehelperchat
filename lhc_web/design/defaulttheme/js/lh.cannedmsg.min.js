var LHCCannedMessageAutoSuggest=function(){function e(e){this.chat_id=e.chat_id,this.suggesting=!1,this.cannedMode=!1,this.currentText=null,this.currentKeword=null,this.initialising=!1,this.timeoutDelay=null;var t=this;this.textarea=jQuery("#CSChatMessage-"+this.chat_id),this.textarea.bind("keyup",function(e){if("#"==e.key||51==e.keyCode||222==e.keyCode)t.currentText=t.textarea.val(),t.showSuggester();else if(32==e.keyCode&&1==t.suggesting)t.stopSuggesting();else if(1==t.suggesting&&38!=e.keyCode&&40!=e.keyCode&&39!=e.keyCode&&37!=e.keyCode&&13!=e.keyCode)t.currentText!==t.textarea.val()&&(t.showSuggester(),t.currentText=t.textarea.val());else if(1!=t.suggesting||37!=e.keyCode&&39!=e.keyCode||t.cannedMode!==!1)0!=t.suggesting||39!=e.keyCode&&37!=e.keyCode&&8!=e.keyCode||null!==t.extractKeyword()&&t.showSuggester();else{var n=t.currentKeword;n!==t.extractKeyword()&&t.showSuggester()}}),this.textarea.bind("keydown",function(e){1==t.suggesting&&(38==e.keyCode?(t.moveAction("up"),e.preventDefault(),e.stopImmediatePropagation()):40==e.keyCode?(t.moveAction("down"),e.preventDefault()):39==e.keyCode||13==e.keyCode?(t.cannedMode===!1?$("#canned-hash-"+t.chat_id+" > li.current-item a").trigger("click"):$("#canned-hash-current-"+t.chat_id+" > ul > li.current-item > span.canned-msg").trigger("click"),e.preventDefault(),e.stopImmediatePropagation()):37==e.keyCode&&t.cannedMode===!0&&($("#canned-hash-current-"+t.chat_id+" > ul > li.current-item > span.left-return").trigger("click"),e.preventDefault(),e.stopImmediatePropagation()))})}return e.prototype.moveAction=function(e){if(this.cannedMode===!1)var t=$("#canned-hash-"+this.chat_id+" > li.current-item");else var t=$("#canned-hash-current-"+this.chat_id+" > ul > li.current-item");if("up"==e){var n=t.prev();n.is("li")&&(t.removeClass("current-item"),n.addClass("current-item"))}else if("down"==e){var i=t.next();i.is("li")&&(t.removeClass("current-item"),i.addClass("current-item"))}},e.prototype.stopSuggesting=function(){this.textarea.parent().find(".canned-suggester").remove(),this.suggesting=!1,this.cannedMode=!1,this.currentText=null,this.currentKeword=null},e.prototype.extractKeyword=function(){var e=this.textarea[0].selectionStart;currentValue=this.textarea.val();var t="";for(i=e;i>0;i--){if(char=currentValue.substring(i-1,i)," "==char)return this.currentKeword=null,null;if("#"==char)return this.currentKeword=t,t;t=char+t}return this.currentKeword=null,null},e.prototype.showSuggester=function(){var e=this;this.extractKeyword(),this.cannedMode=!1,null!==this.currentKeword?this.initialising===!1?(this.initialising=!0,$.getJSON(WWW_DIR_JAVASCRIPT+"cannedmsg/showsuggester/"+this.chat_id,{keyword:this.currentKeword},function(t){e.textarea.parent().find(".canned-suggester").remove(),e.textarea.before(t.result),e.initSuggester(),e.initialising=!1,e.suggesting=!0})):(clearTimeout(this.timeoutDelay),this.timeoutDelay=setTimeout(function(){e.showSuggester()},500)):this.stopSuggesting()},e.prototype.initSuggester=function(){var e=this;$("#canned-hash-"+this.chat_id+" > li:first-child").addClass("current-item"),$("#canned-hash-"+this.chat_id+" > li > a").click(function(){e.cannedMode=!0;var t=$("#canned-hash-current-"+e.chat_id);t.html("").show(),$(this).parent().find("ul").clone().appendTo(t),t.find("ul > li:first-child").addClass("current-item");var n=$(this).parent().parent();n.hide(),t.find("span.canned-msg").click(function(){var t=e.textarea[0].selectionStart,n=e.textarea.val(),i=n.substring(0,t-1-e.currentKeword.length)+$(this).attr("data-msg");if(e.textarea.val(i+n.substring(t)),"selectionStart"in e.textarea[0])e.textarea[0].selectionStart=i.length,e.textarea[0].selectionEnd=i.length;else if(e.textarea[0].setSelectionRange)e.textarea[0].setSelectionRange(i.length,i.length);else if(e.textarea[0].createTextRange){var r=e.textarea[0].createTextRange();r.collapse(!0),r.moveEnd("character",i.length),r.moveStart("character",i.length),r.select()}e.stopSuggesting()}),t.find("span.left-return").click(function(){n.show(),t.html("").hide(),e.cannedMode=!1})}),1==$("#canned-hash-"+this.chat_id+" > li").size()&&$("#canned-hash-"+this.chat_id+" > li > a").trigger("click")},e}();