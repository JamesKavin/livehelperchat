{"version":3,"file":"261.6b105785732f8c16c8f9.js","mappings":"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","sources":["webpack://LHCReactAPP/./src/extensions/nodejs/nodeJSChat.js"],"sourcesContent":["import { helperFunctions } from \"../../lib/helperFunctions\";\nimport { fetchMessages, checkChatStatus, updateMessage } from \"../../actions/chatActions\"\n\nclass _nodeJSChat {\n    constructor() {\n        this.socket = null;\n\n        // On chat close event close connection\n        helperFunctions.eventEmitter.addListener('endedChat', () => {\n            if (this.socket !== null) {\n                this.socket.destroy();\n            }\n        });\n    }\n\n    async bootstrap(params, dispatch, getState) {\n\n        const state = getState();\n        const chatId = state.chatwidget.getIn(['chatData','id']);\n        const chatHash = state.chatwidget.getIn(['chatData','hash']);\n        const syncDefault = state.chatwidget.getIn(['chat_ui','sync_interval']);\n\n        var socketOptions = {\n            hostname: params.hostname,\n            path: params.path,\n            autoReconnectOptions: {initialDelay: 5000, randomness: 5000}\n        }\n\n        if (params.port != '') {\n            socketOptions.port = parseInt(params.port);\n        }\n\n        if (params.secure == 1) {\n            socketOptions.secure = true;\n        }\n\n        var chanelName;\n\n        if (params.instance_id > 0) {\n            chanelName = ('chat_'+params.instance_id+'_'+chatId);\n        } else{\n            chanelName = ('chat_'+chatId);\n        }\n\n        var socketCluster = require('socketcluster-client');\n\n        var socket = this.socket = socketCluster.create(socketOptions);\n        \n        var sampleChannel = null;\n\n\n        let status = await socket.listener('connect').once();\n        if (status.isAuthenticated) {\n            connectVisitor();\n        } else {\n            authentificate();\n        }\n\n        function authentificate() {\n            const state = getState();\n            let chat_id = state.chatwidget.getIn(['chatData','id']);\n            window.lhcAxios.post(window.lhcChat['base_url'] + \"nodejshelper/tokenvisitor/\"+chat_id+\"/\"+state.chatwidget.getIn(['chatData','hash']), null, {headers : {'Content-Type': 'application/x-www-form-urlencoded'}}).then(async (response) => {\n                await Promise.all([\n                    socket.invoke('login', {hash: response.data, chanelName: (params.instance_id > 0 ? ('chat_'+params.instance_id+'_'+chat_id) : ('chat_'+chat_id)) }),\n                    socket.listener('authenticate').once()\n                ]);\n                connectVisitor();\n            });\n        }\n\n        /*socket.on('error', function (err) {\n            console.error(err);\n        });*/\n\n       function visitorTypingListener(data)\n       {\n            if (data.status == true){\n                if (params.instance_id > 0) {\n                    socket.transmitPublish('chat_'+params.instance_id+'_'+chatId,{'op':'vt','msg':data.msg});\n                } else {\n                    socket.transmitPublish('chat_'+chatId,{'op':'vt','msg':data.msg});\n                }\n            } else {\n                if (params.instance_id > 0) {\n                    socket.transmitPublish('chat_'+params.instance_id+'_'+chatId,{'op':'vts'});\n                } else {\n                    socket.transmitPublish('chat_'+chatId,{'op':'vts'});\n                }\n            }\n       }\n\n       function messageSend(data)\n       {\n            if (params.instance_id > 0) {\n                socket.transmitPublish('chat_'+params.instance_id+'_'+chatId, {'op':'vt','msg':'✉️ ' + data.msg});\n            } else {\n                socket.transmitPublish('chat_'+chatId,{'op':'vt', 'msg':'✉️ ' + data.msg});\n            }\n        }\n\n       function messageSendError(data)\n       {\n            if (params.instance_id > 0) {\n                socket.transmitPublish('chat_'+params.instance_id+'_'+chatId,{'op':'vt','msg':'📕️ error happened while sending visitor message, please inform your administrator!'});\n            } else {\n                socket.transmitPublish('chat_'+chatId, {'op':'vt','msg':'📕️ error happened while sending visitor message, please inform your administrator!'});\n            }\n        }\n\n        function disconnect() {\n            if (sampleChannel !== null) {\n                try {\n                    sampleChannel.destroy();\n                } catch (e) {\n\n                }\n            }\n\n            helperFunctions.eventEmitter.removeListener('visitorTyping', visitorTypingListener);\n            helperFunctions.eventEmitter.removeListener('messageSend', messageSend);\n            helperFunctions.eventEmitter.removeListener('messageSendError', messageSendError);\n\n            dispatch({\n                'type': 'CHAT_UI_UPDATE',\n                'data': {sync_interval: syncDefault}\n            });\n\n            dispatch({\n                'type': 'CHAT_REMOVE_OVERRIDE',\n                'data': \"typing\"\n            });\n        }\n\n        /*socket.on('close', function() {\n            disconnect();\n        });*/\n\n        async function connectVisitor() {\n            if (params.instance_id > 0) {\n                sampleChannel = socket.subscribe('chat_'+params.instance_id+'_'+chatId);\n            } else {\n                sampleChannel = socket.subscribe('chat_' + chatId);\n            }\n\n            /*sampleChannel.on('subscribeFail', function (err) {\n                console.error('Failed to subscribe to the sample channel due to error: ' + err);\n            });*/\n\n            //sampleChannel.on('subscribe', function () {\n                socket.transmitPublish((params.instance_id > 0 ? 'chat_'+params.instance_id+'_'+chatId : 'chat_'+chatId), {'op':'vi_online', status: true});\n            //});\n\n            for await (let op of sampleChannel) {\n                if (op.op == 'ot') { // Operator Typing Message\n                    if (op.data.status == true) {\n                        dispatch({\n                            'type': 'chat_status_changed',\n                            'data': {text: op.data.ttx}\n                        });\n                    } else {\n                        dispatch({\n                            'type': 'chat_status_changed',\n                            'data': {text: ''}\n                        });\n                    }\n                } else if (op.op == 'cmsg' || op.op == 'schange') {\n                    const state = getState();\n                    if (state.chatwidget.hasIn(['chatData','id'])){\n                        dispatch(fetchMessages({\n                            'chat_id': state.chatwidget.getIn(['chatData','id']),\n                            'hash' : state.chatwidget.getIn(['chatData','hash']),\n                            'lmgsid' : state.chatwidget.getIn(['chatLiveData','lmsgid']),\n                            'theme' : state.chatwidget.get('theme')\n                        }));\n                    }\n                } else if (op.op == 'umsg') {\n                    const state = getState();\n                    if (state.chatwidget.hasIn(['chatData','id'])) {\n                        updateMessage({'msg_id' :  op.msid,'id' : state.chatwidget.getIn(['chatData','id']), 'hash' : state.chatwidget.getIn(['chatData','hash'])})(dispatch, getState);\n                    }\n                } else if (op.op == 'schange' || op.op == 'cclose') {\n                    const state = getState();\n                    if (state.chatwidget.hasIn(['chatData','id'])){\n                        dispatch(checkChatStatus({\n                            'chat_id': state.chatwidget.getIn(['chatData','id']),\n                            'hash' : state.chatwidget.getIn(['chatData','hash']),\n                            'mode' : state.chatwidget.get('mode'),\n                            'theme' : state.chatwidget.get('theme')\n                        }));\n                    }\n                } else if (op.op == 'vo') {\n                    const state = getState();\n                    if (state.chatwidget.hasIn(['chatData','id'])) {\n                        socket.transmitPublish((params.instance_id > 0 ? 'chat_'+params.instance_id+'_'+state.chatwidget.getIn(['chatData','id']) : 'chat_'+state.chatwidget.getIn(['chatData','id'])) ,{'op':'vi_online', status: true});\n                    }\n                }\n            }\n\n            helperFunctions.eventEmitter.addListener('visitorTyping', visitorTypingListener);\n            helperFunctions.eventEmitter.addListener('messageSend', messageSend);\n            helperFunctions.eventEmitter.addListener('messageSendError', messageSendError);\n\n            dispatch({\n                'type': 'CHAT_UI_UPDATE',\n                'data': {sync_interval: 10000}\n            });\n\n            dispatch({\n                'type': 'CHAT_ADD_OVERRIDE',\n                'data': \"typing\"\n            });\n        }\n\n        /*socket.on('deauthenticate', function(){\n            const state = getState();\n            let chat_id = state.chatwidget.getIn(['chatData','id']);\n            window.lhcAxios.post(window.lhcChat['base_url'] + \"nodejshelper/tokenvisitor/\"+chat_id+\"/\"+state.chatwidget.getIn(['chatData','hash']), null, {headers : {'Content-Type': 'application/x-www-form-urlencoded'}}).then((response) => {\n                socket.emit('login', {hash:response.data, chanelName: (params.instance_id > 0 ? ('chat_'+params.instance_id+'_'+chat_id) : ('chat_'+chat_id)) }, function (err) {\n                    if (err) {\n                        console.log(err);\n                        disconnect();\n                    }\n                });\n            });\n        });*/\n\n        for await (let event of socket.listener('deauthenticate')) {\n            authentificate();\n        }\n\n        /*socket.on('connect', function (status) {\n            if (status.isAuthenticated && chatId > 0) {\n                connectVisitor();\n            } else {\n                const state = getState();\n                let chat_id = state.chatwidget.getIn(['chatData','id']);\n                window.lhcAxios.post(window.lhcChat['base_url'] + \"nodejshelper/tokenvisitor/\"+chat_id+\"/\"+state.chatwidget.getIn(['chatData','hash']), null, {headers : {'Content-Type': 'application/x-www-form-urlencoded'}}).then((response) => {\n                    socket.emit('login', {hash: response.data, chanelName: (params.instance_id > 0 ? ('chat_'+params.instance_id+'_'+chat_id) : ('chat_'+chat_id)) }, function (err) {\n                        if (err) {\n                            console.log(err);\n                            socket.destroy();\n                        } else {\n                            connectVisitor();\n                        }\n                    });\n                });\n            }\n        });*/\n    }\n}\n\nconst nodeJSChat = new _nodeJSChat();\nexport { nodeJSChat };"],"names":["nodeJSChat","_nodeJSChat","this","socket","helperFunctions","destroy","params","dispatch","getState","authentificate","visitorTypingListener","messageSend","messageSendError","connectVisitor","sampleChannel","instance_id","subscribe","chatId","transmitPublish","status","op","data","text","ttx","state","chatwidget","hasIn","fetchMessages","getIn","get","updateMessage","msid","checkChatStatus","sync_interval","msg","chat_id","window","lhcAxios","post","lhcChat","headers","then","response","Promise","all","invoke","hash","chanelName","listener","once","socketOptions","hostname","path","autoReconnectOptions","initialDelay","randomness","port","parseInt","secure","socketCluster","require","create","isAuthenticated"],"sourceRoot":""}