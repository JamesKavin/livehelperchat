{"version":3,"file":"261.fa77c0518284c25d9702.js","mappings":"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","sources":["webpack://LHCReactAPP/./src/extensions/nodejs/nodeJSChat.js"],"sourcesContent":["import { helperFunctions } from \"../../lib/helperFunctions\";\nimport { fetchMessages, checkChatStatus, updateMessage } from \"../../actions/chatActions\"\n\nclass _nodeJSChat {\n    constructor() {\n        this.socket = null;\n\n        // On chat close event close connection\n        helperFunctions.eventEmitter.addListener('endedChat', () => {\n            if (this.socket !== null) {\n                this.socket.disconnect();\n            }\n        });\n    }\n\n    bootstrap(params, dispatch, getState) {\n\n        const state = getState();\n        const chatId = state.chatwidget.getIn(['chatData','id']);\n        const chatHash = state.chatwidget.getIn(['chatData','hash']);\n        const syncDefault = state.chatwidget.getIn(['chat_ui','sync_interval']);\n\n        var socketOptions = {\n            hostname: params.hostname,\n            path: params.path,\n            autoReconnectOptions: {initialDelay: 5000, randomness: 5000}\n        }\n\n        if (params.port != '') {\n            socketOptions.port = parseInt(params.port);\n        }\n\n        if (params.secure == 1) {\n            socketOptions.secure = true;\n        }\n\n        var chanelName;\n\n        if (params.instance_id > 0) {\n            chanelName = ('chat_'+params.instance_id+'_'+chatId);\n        } else{\n            chanelName = ('chat_'+chatId);\n        }\n\n        var socketCluster = require('socketcluster-client');\n\n        var socket = this.socket = socketCluster.create(socketOptions);\n        \n        var sampleChannel = null;\n\n        (async () => {\n            for await (let status of socket.listener('connect')) {\n                if (status.isAuthenticated && chatId > 0) {\n                    connectVisitor();\n                } else {\n                    authentificate();\n                }\n            }\n        })();\n\n        function authentificate() {\n            const state = getState();\n            let chat_id = state.chatwidget.getIn(['chatData','id']);\n            window.lhcAxios.post(window.lhcChat['base_url'] + \"nodejshelper/tokenvisitor/\"+chat_id+\"/\"+state.chatwidget.getIn(['chatData','hash']), null, {headers : {'Content-Type': 'application/x-www-form-urlencoded'}}).then(async (response) => {\n                await Promise.all([\n                    socket.invoke('login', {hash: response.data, chanelName: (params.instance_id > 0 ? ('chat_'+params.instance_id+'_'+chat_id) : ('chat_'+chat_id)) }),\n                    socket.listener('authenticate').once()\n                ]);\n                connectVisitor();\n            });\n        }\n\n       function visitorTypingListener(data)\n       {\n            if (data.status == true){\n                if (params.instance_id > 0) {\n                    socket.transmitPublish('chat_'+params.instance_id+'_'+chatId,{'op':'vt','msg':data.msg});\n                } else {\n                    socket.transmitPublish('chat_'+chatId,{'op':'vt','msg':data.msg});\n                }\n            } else {\n                if (params.instance_id > 0) {\n                    socket.transmitPublish('chat_'+params.instance_id+'_'+chatId,{'op':'vts'});\n                } else {\n                    socket.transmitPublish('chat_'+chatId,{'op':'vts'});\n                }\n            }\n       }\n\n       function messageSend(data)\n       {\n            if (params.instance_id > 0) {\n                socket.transmitPublish('chat_'+params.instance_id+'_'+chatId, {'op':'vt','msg':'✉️ ' + data.msg});\n            } else {\n                socket.transmitPublish('chat_'+chatId,{'op':'vt', 'msg':'✉️ ' + data.msg});\n            }\n        }\n\n       function messageSendError(data)\n       {\n            if (params.instance_id > 0) {\n                socket.transmitPublish('chat_'+params.instance_id+'_'+chatId,{'op':'vt','msg':'📕️ error happened while sending visitor message, please inform your administrator!'});\n            } else {\n                socket.transmitPublish('chat_'+chatId, {'op':'vt','msg':'📕️ error happened while sending visitor message, please inform your administrator!'});\n            }\n        }\n\n        function disconnect() {\n\n            if (sampleChannel !== null) {\n                try {\n                    sampleChannel.unsubscribe();\n                } catch (e) {\n\n                }\n            }\n\n            helperFunctions.eventEmitter.removeListener('visitorTyping', visitorTypingListener);\n            helperFunctions.eventEmitter.removeListener('messageSend', messageSend);\n            helperFunctions.eventEmitter.removeListener('messageSendError', messageSendError);\n\n            dispatch({\n                'type': 'CHAT_UI_UPDATE',\n                'data': {sync_interval: syncDefault}\n            });\n\n            dispatch({\n                'type': 'CHAT_REMOVE_OVERRIDE',\n                'data': \"typing\"\n            });\n        }\n\n        (async () => {\n            for await (let event of socket.listener('disconnect')) {\n                disconnect();\n            }\n        })();\n\n        function connectVisitor() {\n\n            var firstRun = sampleChannel == null;\n\n            if (params.instance_id > 0) {\n                sampleChannel = socket.subscribe('chat_'+params.instance_id+'_'+chatId);\n            } else {\n                sampleChannel = socket.subscribe('chat_' + chatId);\n            }\n\n            helperFunctions.eventEmitter.addListener('visitorTyping', visitorTypingListener);\n            helperFunctions.eventEmitter.addListener('messageSend', messageSend);\n            helperFunctions.eventEmitter.addListener('messageSendError', messageSendError);\n\n            dispatch({\n                'type': 'CHAT_UI_UPDATE',\n                'data': {sync_interval: 10000}\n            });\n\n            dispatch({\n                'type': 'CHAT_ADD_OVERRIDE',\n                'data': \"typing\"\n            });\n\n            if (firstRun == true)\n            {\n                (async () => {\n                    for await (let event of sampleChannel.listener('subscribe')) {\n                        socket.transmitPublish((params.instance_id > 0 ? 'chat_' + params.instance_id + '_' + chatId : 'chat_' + chatId), {\n                            'op': 'vi_online',\n                            status: true\n                        });\n                    }\n                })();\n                (async () => {\n                    for await (let op of sampleChannel) {\n                    if (op.op == 'ot') { // Operator Typing Message\n                        if (op.data.status == true) {\n                            dispatch({\n                                'type': 'chat_status_changed',\n                                'data': {text: op.data.ttx}\n                            });\n                        } else {\n                            dispatch({\n                                'type': 'chat_status_changed',\n                                'data': {text: ''}\n                            });\n                        }\n                    } else if (op.op == 'cmsg' || op.op == 'schange') {\n                        const state = getState();\n                        if (state.chatwidget.hasIn(['chatData','id'])){\n                            dispatch(fetchMessages({\n                                'chat_id': state.chatwidget.getIn(['chatData','id']),\n                                'hash' : state.chatwidget.getIn(['chatData','hash']),\n                                'lmgsid' : state.chatwidget.getIn(['chatLiveData','lmsgid']),\n                                'theme' : state.chatwidget.get('theme')\n                            }));\n                        }\n                    } else if (op.op == 'umsg') {\n                        const state = getState();\n                        if (state.chatwidget.hasIn(['chatData','id'])) {\n                            updateMessage({'msg_id' :  op.msid,'id' : state.chatwidget.getIn(['chatData','id']), 'hash' : state.chatwidget.getIn(['chatData','hash'])})(dispatch, getState);\n                        }\n                    } else if (op.op == 'schange' || op.op == 'cclose') {\n                        const state = getState();\n                        if (state.chatwidget.hasIn(['chatData','id'])){\n                            dispatch(checkChatStatus({\n                                'chat_id': state.chatwidget.getIn(['chatData','id']),\n                                'hash' : state.chatwidget.getIn(['chatData','hash']),\n                                'mode' : state.chatwidget.get('mode'),\n                                'theme' : state.chatwidget.get('theme')\n                            }));\n                        }\n                    } else if (op.op == 'vo') {\n                        const state = getState();\n                        if (state.chatwidget.hasIn(['chatData','id'])) {\n                            socket.transmitPublish((params.instance_id > 0 ? 'chat_'+params.instance_id+'_'+state.chatwidget.getIn(['chatData','id']) : 'chat_'+state.chatwidget.getIn(['chatData','id'])) ,{'op':'vi_online', status: true});\n                        }\n                    }\n                }\n                })();\n            }\n       }\n\n       (async () => {\n            for await (let event of socket.listener('deauthenticate')) {\n                console.log('authentificate');\n                authentificate();\n            }\n       })();\n    }\n}\n\nconst nodeJSChat = new _nodeJSChat();\nexport { nodeJSChat };"],"names":["nodeJSChat","_nodeJSChat","this","socket","helperFunctions","disconnect","params","dispatch","getState","state","chatId","chatwidget","getIn","syncDefault","socketOptions","hostname","path","autoReconnectOptions","initialDelay","randomness","port","parseInt","secure","instance_id","socketCluster","require","create","sampleChannel","authentificate","chat_id","window","lhcAxios","post","lhcChat","headers","then","response","Promise","all","invoke","hash","data","chanelName","listener","once","connectVisitor","visitorTypingListener","status","transmitPublish","msg","messageSend","messageSendError","unsubscribe","e","sync_interval","firstRun","subscribe","op","text","ttx","hasIn","fetchMessages","get","updateMessage","msid","checkChatStatus","isAuthenticated","console","log"],"sourceRoot":""}