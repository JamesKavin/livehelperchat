"use strict";(self.webpackChunkLHCReactAPPAdmin=self.webpackChunkLHCReactAPPAdmin||[]).push([[653],{3653:(e,t,a)=>{a.r(t),a.d(t,{default:()=>L});var n=a(885),r=a(4942),l=a(7294),s=a(9669),i=a.n(s),c=a(6793),o=a(488),m=a.n(o),u=function(e){var t=e.children,a=(0,l.useState)(!1),r=(0,n.Z)(a,2),s=r[0],i=r[1];return l.createElement(l.Fragment,null,l.createElement("div",{className:"pb-2"},l.createElement("button",{onClick:function(){return i(!s)},className:"btn btn-sm btn-outline-secondary"},"...")),s&&t)};const d=l.memo(u);var p=a(2982),f=a(5074),v=a(5861),g=a(5671),_=a(3144),E=a(7326),h=a(9340),b=a(2963),y=a(1120),N=a(7757),w=a.n(N),k=a(560);function R(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function x(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?R(Object(a),!0).forEach((function(t){(0,r.Z)(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):R(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}var C=function(e){(0,h.Z)(i,e);var t,a,n,s=(a=i,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=(0,y.Z)(a);if(n){var r=(0,y.Z)(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return(0,b.Z)(this,e)});function i(e){var t;return(0,g.Z)(this,i),t=s.call(this,e),(0,r.Z)((0,E.Z)(t),"state",{hightlight:!1,files:[],uploading:!1,uploadProgress:{},successfullUploaded:!1,progress:""}),t.fileInputRef=l.createRef(),t.dropAreaRef=l.createRef(),t.openFileDialog=t.openFileDialog.bind((0,E.Z)(t)),t.onFilesAddedUI=t.onFilesAddedUI.bind((0,E.Z)(t)),t.onDragOver=t.onDragOver.bind((0,E.Z)(t)),t.onDragLeave=t.onDragLeave.bind((0,E.Z)(t)),t.onDrop=t.onDrop.bind((0,E.Z)(t)),t.onPaste=t.onPaste.bind((0,E.Z)(t)),t.onFilesAdded=t.onFilesAdded.bind((0,E.Z)(t)),t.uploadFiles=t.uploadFiles.bind((0,E.Z)(t)),t.sendRequest=t.sendRequest.bind((0,E.Z)(t)),t.chooseFromUploaded=t.chooseFromUploaded.bind((0,E.Z)(t)),t.fileUploaded=t.fileUploaded.bind((0,E.Z)(t)),t}return(0,_.Z)(i,[{key:"onFilesAdded",value:function(e){var t=this,a=this.props.t,n=new RegExp("(.|/)("+this.props.moptions.fop_op+")$","i"),r=[];e.forEach((function(e){n.test(e.type)||n.test(e.name)||r.push(e.name+": "+a("file.incorrect_type")),e.size>t.props.moptions.fop_size&&r.push(e.name+": "+a("file.to_big_file"))})),r.length>0?alert(r.join("\n")):this.setState({files:e})}},{key:"componentDidUpdate",value:function(e,t){this.state.files.length>0&&0==this.state.uploading&&this.uploadFiles()}},{key:"uploadFiles",value:(t=(0,v.Z)(w().mark((function e(){var t,a=this;return w().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.setState({uploadProgress:{},uploading:!0}),t=[],this.state.files.forEach((function(e){t.push(a.sendRequest(e))})),e.prev=3,e.next=6,Promise.all(t);case 6:this.setState({successfullUploaded:!0,uploading:!1,files:[]}),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(3),this.setState({successfullUploaded:!0,uploading:!1,files:[]});case 12:case"end":return e.stop()}}),e,this,[[3,9]])}))),function(){return t.apply(this,arguments)})},{key:"fileUploaded",value:function(e){this.props.fileAttached(e)}},{key:"sendRequest",value:function(e){var t=this,a=this.props.t;return new Promise((function(n,r){var l=new XMLHttpRequest;l.upload.addEventListener("progress",(function(n){n.lengthComputable&&(x({},t.state.uploadProgress)[e.name]={state:"pending",percentage:n.loaded/n.total*100},t.setState({progress:a("file.uploading")+" "+Math.round(n.loaded/n.total*100)+"%"}))})),l.upload.addEventListener("load",(function(a){x({},t.state.uploadProgress)[e.name]={state:"done",percentage:100},t.setState({progress:""}),n(l.response)}));var s=t;l.onreadystatechange=function(){4===l.readyState&&s.fileUploaded(JSON.parse(l.response))},l.upload.addEventListener("error",(function(a){var n=x({},t.state.uploadProgress);n[e.name]={state:"error",percentage:0},t.setState({progress:n}),r(l.response)}));var i=new FormData;i.append("files",e,e.name),l.open("POST",WWW_DIR_JAVASCRIPT+"mailconv/uploadfile"),l.send(i)}))}},{key:"openFileDialog",value:function(){this.state.uploading||this.fileInputRef.current.click()}},{key:"onFilesAddedUI",value:function(e){var t=e.target.files,a=this.fileListToArray(t);this.onFilesAdded(a)}},{key:"onDragOver",value:function(e){e.preventDefault(),this.state.uploading||this.setState({hightlight:!0})}},{key:"componentDidMount",value:function(){this.dropAreaRef.current&&(this.dropAreaRef.current.ondragover=this.onDragOver,this.dropAreaRef.current.ondragleave=this.onDragLeave,this.dropAreaRef.current.ondrop=this.onDrop)}},{key:"componentWillUnmount",value:function(){this.dropAreaRef.current&&(this.dropAreaRef.current.ondragover=null,this.dropAreaRef.current.ondragleave=null,this.dropAreaRef.current.ondrop=null),window.attatchReplyCurrent=null}},{key:"onPaste",value:function(e){var t=e&&e.clipboardData&&e.clipboardData.items;if(t&&t.length){for(var a=[],n=0;n<t.length;n++){var r=t[n].getAsFile&&t[n].getAsFile();r&&a.push(r)}a.length>0&&this.onFilesAdded(a)}}},{key:"onDragLeave",value:function(e){this.setState({hightlight:!1})}},{key:"onDrop",value:function(e){if(e.preventDefault(),!this.state.uploading){var t=e.dataTransfer.files,a=this.fileListToArray(t);this.onFilesAdded(a),this.setState({hightlight:!1})}}},{key:"fileListToArray",value:function(e){for(var t=[],a=0;a<e.length;a++)t.push(e.item(a));return t}},{key:"chooseFromUploaded",value:function(){var e=this.props.t;lhc.revealModal({title:e("file.choose_uploaded"),iframe:!0,height:500,url:WWW_DIR_JAVASCRIPT+"mailconv/attatchfile/(attachment)/1"});var t=this;window.attatchReplyCurrent=function(e){t.props.fileAttached(e)}}},{key:"render",value:function(){var e=this.props.t;return l.createElement(l.Fragment,null,l.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:this.chooseFromUploaded},l.createElement("i",{className:"material-icons"},"list")," ",e("file.choose_uploaded")),l.createElement("button",{ref:this.dropAreaRef,onClick:this.openFileDialog,className:"btn btn-sm "+(1==this.state.hightlight?"btn-outline-primary":"btn-outline-secondary")},l.createElement("i",{className:"material-icons"},"attach_file")," ",this.state.progress||e("file.drop_here")),l.createElement("input",{onChange:this.onFilesAddedUI,ref:this.fileInputRef,id:"fileupload",type:"file",name:"files[]",multiple:!0,className:"d-none"}))}}]),i}(l.PureComponent);const I=(0,k.Z)("mail_chat")(C);function A(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function S(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?A(Object(a),!0).forEach((function(t){(0,r.Z)(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):A(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}var O=function(e){var t=(0,l.useReducer)((function(e,t){var a=t.type,n=t.value;switch(a){case"add":return[].concat((0,p.Z)(e),[n]);case"add_recipient":return(e=S({},e))[n].push({name:"",email:""}),e;case"remove_recipient":return(e=S({},e))[n.recipient]=e[n.recipient].filter((function(e,t){return t!==n.index})),e;case"set":return n;case"set_attribute":return(e=S({},e))[n.value.type][n.value.index][n.value.field]=n.value.value,e;case"cleanup":return[];case"remove":return e.filter((function(e,t){return t!==n}));default:return e}}),[]),a=(0,n.Z)(t,2),s=a[0],i=a[1],o=function(t,a){i({type:t,value:a}),e.setRecipients(s)};(0,l.useEffect)((function(){i({type:"set",value:e.recipients}),e.setRecipients(e.recipients)}),[e.recipients]);var m=(0,c.$)("mail_chat"),u=m.t;return m.i18n,l.createElement("div",{className:"row"},!e.readOnly&&l.createElement("div",{className:"col-12 text-secondary font-weight-bold fs13 pb-1"},u("r.recipients")," ",l.createElement("i",{className:"material-icons settings text-muted",onClick:function(e){return o("add_recipient","reply")},style:{fontSize:"20px"}},"add")," Cc ",l.createElement("i",{className:"material-icons settings text-muted",onClick:function(e){return o("add_recipient","cc")},style:{fontSize:"20px"}},"add")," Bcc ",l.createElement("i",{onClick:function(e){return o("add_recipient","bcc")},className:"material-icons settings text-muted",style:{fontSize:"20px"}},"add")),l.createElement("div",{className:"col-6"},s.reply&&s.reply.map((function(t,a){var n;return l.createElement("div",{className:"form-row pb-1"},l.createElement("div",{className:"col-1 text-secondary fs13 pt-1"},u("r.to"),":"),l.createElement("div",{className:"col-5"},l.createElement("div",{className:"input-group input-group-sm"},l.createElement("div",{className:"input-group-prepend"},l.createElement("span",{className:"input-group-text"},l.createElement("i",{className:"material-icons mr-0"},"mail_outline"))),l.createElement("input",(n={disabled:e.readOnly,type:"text",className:"form-control form-control-sm",placeholder:"E-mail",onChange:function(e){return o("set_attribute",{value:{value:e.target.value,type:"reply",index:a,field:"email"}})},value:t.email},(0,r.Z)(n,"placeholder",u("r.email")),(0,r.Z)(n,"aria-describedby","validationTooltipUsernamePrepend"),n)))),l.createElement("div",{className:"col-5"},l.createElement("input",{type:"text",disabled:e.readOnly,placeholder:u("r.name"),onChange:function(e){return o("set_attribute",{value:{value:e.target.value,type:"reply",index:a,field:"name"}})},value:t.name,className:"form-control form-control-sm"})),!e.readOnly&&a>0&&l.createElement("div",{className:"col"},l.createElement("i",{className:"material-icons settings text-muted",onClick:function(e){return o("remove_recipient",{recipient:"reply",index:a})}},"remove")))}))),l.createElement("div",{className:"col-6"},s.cc&&s.cc.map((function(t,a){var n;return l.createElement("div",{className:"form-row pb-1"},l.createElement("div",{className:"col-1 text-secondary fs13 pt-1"},"Cc:"),l.createElement("div",{className:"col-5"},l.createElement("div",{className:"input-group input-group-sm"},l.createElement("div",{className:"input-group-prepend"},l.createElement("span",{className:"input-group-text"},l.createElement("i",{className:"material-icons mr-0"},"mail_outline"))),l.createElement("input",(n={type:"text",disabled:e.readOnly,className:"form-control form-control-sm",placeholder:"E-mail",onChange:function(e){return o("set_attribute",{value:{value:e.target.value,type:"cc",index:a,field:"email"}})},value:t.email},(0,r.Z)(n,"placeholder",u("r.email")),(0,r.Z)(n,"aria-describedby","validationTooltipUsernamePrepend"),n)))),l.createElement("div",{className:"col-5"},l.createElement("input",{disabled:e.readOnly,type:"text",placeholder:u("r.name"),onChange:function(e){return o("set_attribute",{value:{value:e.target.value,type:"cc",index:a,field:"name"}})},value:t.name,className:"form-control form-control-sm"})),!e.readOnly&&l.createElement("div",{className:"col"},l.createElement("i",{className:"material-icons settings text-muted",onClick:function(e){return o("remove_recipient",{recipient:"cc",index:a})}},"remove")))}))),l.createElement("div",{className:"col-6"},s.bcc&&s.bcc.map((function(t,a){var n;return l.createElement("div",{className:"form-row pb-1"},l.createElement("div",{className:"col-1 text-secondary fs13 pt-1"},"Bcc:"),l.createElement("div",{className:"col-5"},l.createElement("div",{className:"input-group input-group-sm"},l.createElement("div",{className:"input-group-prepend"},l.createElement("span",{className:"input-group-text"},l.createElement("i",{className:"material-icons mr-0"},"mail_outline"))),l.createElement("input",(n={type:"text",disabled:e.readOnly,className:"form-control form-control-sm",placeholder:"E-mail",onChange:function(e){return o("set_attribute",{value:{value:e.target.value,type:"bcc",index:a,field:"email"}})},value:t.email},(0,r.Z)(n,"placeholder",u("r.email")),(0,r.Z)(n,"aria-describedby","validationTooltipUsernamePrepend"),n)))),l.createElement("div",{className:"col-5"},l.createElement("input",{type:"text",disabled:e.readOnly,placeholder:u("r.name"),onChange:function(e){return o("set_attribute",{value:{value:e.target.value,type:"bcc",index:a,field:"name"}})},value:t.name,className:"form-control form-control-sm"})),!e.readOnly&&l.createElement("div",{className:"col"},l.createElement("i",{className:"material-icons settings text-muted",onClick:function(e){return o("remove_recipient",{recipient:"bcc",index:a})}},"remove")))}))))};const W=l.memo(O);var P=function(e){var t=(0,l.useState)(!1),a=(0,n.Z)(t,2);return a[0],a[1],l.createElement(l.Fragment,null,e.status.send&&l.createElement("div",{className:"alert alert-success p-1 pl-2",role:"alert"},"Success!"),!e.status.send&&l.createElement("div",{className:"alert alert-danger p-1 pl-2",role:"alert"},l.createElement("ul",{className:"mb-0"},e.status.errors.general&&l.createElement("li",null,e.status.errors.general),e.status.errors.reply&&l.createElement("li",null,e.status.errors.reply),e.status.errors.content&&l.createElement("li",null,e.status.errors.content)),e.status.errors.raw_error&&l.createElement("div",null,l.createElement("h4",null,"An unknown error happened while sending an email. Please reload a window!"),l.createElement("div",null,l.createElement("button",{className:"btn btn-danger"},"Reload this window.")),l.createElement("p",null,"Please copy error text and send to your manager!"),l.createElement("textarea",{className:"form-control form-control-sm",rows:"5"},e.status.errors.raw_error))))};const D=l.memo(P);var Z=function(e){var t=(0,l.useState)(!1),a=(0,n.Z)(t,2),s=a[0],o=a[1],m=(0,l.useState)(!1),u=(0,n.Z)(m,2),d=u[0],v=u[1],g=(0,l.useState)(null),_=(0,n.Z)(g,2),E=(_[0],_[1],(0,l.useState)(null)),h=(0,n.Z)(E,2),b=h[0],y=h[1],N=(0,l.useState)(null),w=(0,n.Z)(N,2),k=w[0],R=w[1],x=(0,l.useState)(!1),C=(0,n.Z)(x,2),A=C[0],S=C[1],O=(0,l.useState)([]),P=(0,n.Z)(O,2),Z=P[0],j=P[1],T=(0,l.useState)([]),F=(0,n.Z)(T,2),M=F[0],V=F[1],J=(0,l.useState)([]),L=(0,n.Z)(J,2),U=L[0],q=L[1],$=(0,l.useState)(!1),B=(0,n.Z)($,2),H=B[0],z=B[1],K=(0,l.useState)(!1),X=(0,n.Z)(K,2),G=X[0],Q=X[1],Y=(0,l.useState)(!0),ee=(0,n.Z)(Y,2),te=ee[0],ae=ee[1],ne=(0,l.useReducer)((function(e,t){var a=t.type,n=t.value;switch(a){case"add":return[].concat((0,p.Z)(e),[n]);case"cleanup":return[];case"remove":return e.filter((function(e,t){return t!==n}));default:return e}}),[]),re=(0,n.Z)(ne,2),le=re[0],se=re[1],ie=(0,l.useRef)();ie.current=le;var ce=function(t){var a={recipients:M,content:tinyMCE.get("reply-to-mce-"+e.message.id).getContent(),attatchements:le,status:t,mode:1==s?"reply":"forward"};z(!0),i().post(WWW_DIR_JAVASCRIPT+"mailconv/apisendreply/"+e.message.id,a).then((function(t){console.log(t),q(t.data),z(!1),1==t.data.send&&(e.fetchMessages(),e.setConversationStatus(t.data.conv_status))})).catch((function(e){z(!1),e.response?400===e.response.status?q(e.response.data):q({send:!1,send_tried:!0,errors:{raw_error:e.response.data}}):e.request?console.log(e.request):console.log("Error",e.message),console.log(e.config)}))};(0,l.useEffect)((function(){return function(){ie.current.map((function(e,t){!0===e.new&&i().get(WWW_DIR_JAVASCRIPT+"file/delete/"+e.id+"/(csfr)/"+confLH.csrf_token+"?react=1")}))}}),[]),(0,l.useEffect)((function(){1!=s&&1!=d||0!=A?0==s&&0==d&&1==A&&(S(!1),ie.current.length>0&&(ie.current.map((function(e,t){!0===e.new&&i().get(WWW_DIR_JAVASCRIPT+"file/delete/"+e.id+"/(csfr)/"+confLH.csrf_token+"?react=1")})),se({type:"cleanup"}))):i().post(WWW_DIR_JAVASCRIPT+"mailconv/getreplydata/"+e.message.id+"/"+(1==s?"reply":"forward")).then((function(t){S(!0),y(t.data.intro),R(t.data.signature),j(t.data.recipients),Q(t.data.signature_under),t.data.user_id>0&&(e.verifyOwner(t.data.user_id),ae(t.data.is_owner))}))}),[s,d]),1==e.replyMode&&0==s&&(1==d&&(S(!1),v(!1)),o(!0)),1==e.forwardMode&&0==d&&(1==s&&(S(!1),o(!1)),v(!0));var oe=(0,c.$)("mail_chat"),me=oe.t;return oe.i18n,l.createElement(l.Fragment,null,l.createElement("div",{className:"col-12 mt-2 pt-3 pb-2"},!te&&l.createElement("div",{className:"alert alert-warning",role:"alert"},l.createElement("span",{className:"material-icons"},"warning"),me("msg.not_an_owner")),!s&&!d&&!e.fetchingMessages&&l.createElement("div",{className:"btn-group",role:"group","aria-label":"Mail actions"},l.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:function(){v(!1),o(!0)}},l.createElement("i",{className:"material-icons"},"reply"),me("msg.reply")),l.createElement("button",{disabled:1==e.message.response_type,type:"button",className:"btn btn-sm btn-outline-secondary",onClick:function(){return e.noReplyRequired()}},l.createElement("i",{className:"material-icons"},"done"),me("msg.nrr")),!e.moptions.hide_recipients&&l.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:function(){o(!1),v(!0)}},l.createElement("i",{className:"material-icons"},"forward"),me("msg.forward"))),!e.fetchingMessages&&(s||d)&&A&&l.createElement("div",{className:"shadow p-2"},U.send_tried&&l.createElement(D,{status:U}),l.createElement(W,{readOnly:e.moptions.hide_recipients,setRecipients:function(e){return V(e)},mode:1==s?"reply":"forward",message:e.message,recipients:Z}),l.createElement(f.M,{tinymceScriptSrc:"/design/defaulttheme/js/tinymce/js/tinymce/tinymce.min.js",initialValue:"<p></p>"+b+"<blockquote>"+e.message.body_front+"</blockquote>"+(0==G?k:""),onInit:function(){tinyMCE.get("reply-to-mce-"+e.message.id).focus()},id:"reply-to-mce-"+e.message.id,init:{height:320,automatic_uploads:e.moptions.files_enabled,file_picker_types:"image",images_upload_url:WWW_DIR_JAVASCRIPT+"mailconv/uploadimage",templates:WWW_DIR_JAVASCRIPT+"mailconv/apiresponsetemplates/"+e.message.id,paste_data_images:e.moptions.files_enabled,relative_urls:!1,browser_spellcheck:!0,paste_as_text:!0,contextmenu:!1,menubar:!1,plugins:e.moptions.mce_plugins,toolbar_mode:"wrap",toolbar:e.moptions.mce_toolbar}}),s&&l.createElement("div",{className:"float-right"},l.createElement("a",{className:"action-image",onClick:function(){o(!1),e.cancelReply()}},l.createElement("i",{className:"material-icons"},"delete"))),d&&l.createElement("div",{className:"float-right"},l.createElement("a",{className:"action-image",onClick:function(){v(!1),e.cancelForward()}},l.createElement("i",{className:"material-icons"},"delete"))),l.createElement("div",{className:"btn-group mt-2",role:"group","aria-label":"Mail actions"},l.createElement("button",{type:"button",disabled:H,className:"btn btn-sm btn-primary",onClick:function(){return ce(2)}},l.createElement("i",{className:"material-icons"},"send"),me(1==H?"msg.sending":"msg.send_and_close")),e.moptions.send_as_new&&l.createElement("button",{type:"button",disabled:H,className:"btn btn-sm btn-outline-secondary",onClick:function(){return ce(0)}},l.createElement("i",{className:"material-icons text-warning"},"send"),me(1==H?"msg.sending":"msg.send_as_pending")),l.createElement("button",{type:"button",disabled:H,className:"btn btn-sm btn-outline-secondary",onClick:function(){return ce(1)}},l.createElement("i",{className:"material-icons text-success"},"send"),me(1==H?"msg.sending":"msg.send_as_active"))),e.moptions.files_enabled&&l.createElement("div",{className:"btn-group d-block mt-2",role:"group","aria-label":"Mail actions"},l.createElement(I,{moptions:e.moptions,fileAttached:function(e){return se({type:"add",value:e})},message:e.message})),le&&le.length>0&&l.createElement("div",{className:"pt-2"},le.map((function(e,t){return l.createElement("button",(0,r.Z)({title:me("msg.click_to_remove"),onClick:function(){return function(e,t){se({type:"remove",value:t}),!0===e.new&&i().get(WWW_DIR_JAVASCRIPT+"file/delete/"+e.id+"/(csfr)/"+confLH.csrf_token+"?react=1")}(e,t)},className:"btn btn-sm btn-outline-info mr-1 mb-1"},"title",e.id),e.name)}))))))};const j=l.memo(Z);var T=function(e){var t=e.message,a=e.index,r=e.totalMessages,s=e.noReplyRequired,i=e.mode,u=e.addLabel,p=e.moptions,f=e.fetchMessages,v=e.fetchingMessages,g=e.verifyOwner,_=e.setConversationStatus,E=(0,l.useState)(!1),h=(0,n.Z)(E,2),b=h[0],y=h[1],N=(0,l.useState)(a+1==r),w=(0,n.Z)(N,2),k=w[0],R=w[1],x=(0,l.useState)(!!t.undelivered),C=(0,n.Z)(x,2),I=C[0],A=C[1],S=(0,l.useState)(!1),O=(0,n.Z)(S,2),W=O[0],P=O[1],D=(0,l.useState)(!1),Z=(0,n.Z)(D,2),T=Z[0],F=Z[1],M=(0,l.useState)(!1),V=(0,n.Z)(M,2),J=V[0],L=V[1];1!=v||1!=W&&1!=T||(P(!1),F(!1));var U=(0,c.$)("mail_chat"),q=U.t;return U.i18n,l.createElement("div",{className:"row pb-2 mb-2 border-secondary"+("preview"!==i?" border-top pt-2":" border-bottom")},l.createElement("div",{className:"col-7 action-image",onClick:function(){return R(!k)}},l.createElement("span",{title:"Expand message "+t.id},l.createElement("i",{className:"material-icons"},k?"expand_less":"expand_more")),l.createElement("b",null,t.from_name),l.createElement("small",null," <",t.from_address,"> "),l.createElement("small",{className:t.status&&1!=t.status?t.cls_time?"chat-closed":"chat-active":"chat-pending"},l.createElement("i",{className:"material-icons"},"mail_outline"),t.status&&1!=t.status?"Responded":"Pending response")),l.createElement("div",{className:"col-5 text-right text-muted"},l.createElement("small",{className:"pr-1"},t.subjects&&t.subjects.map((function(e,t){return l.createElement("span",{className:"badge badge-info mr-1"},e.name)})),"preview"!==i&&p.can_write&&l.createElement(l.Fragment,null,l.createElement("i",{title:q("msg.ar_label"),onClick:function(){return u(t)},className:"material-icons action-image text-muted"},"label")," |")),l.createElement("small",{className:"pr-2"},t.udate_front," | ",t.udate_ago," ",q("msg.ago"),"."),"preview"!==i&&l.createElement("i",{onClick:function(e){e.stopPropagation(),F(!1),P(!0)},className:"material-icons settings text-muted"},"reply"),l.createElement("i",{onClick:function(e){e.stopPropagation(),y(!b)},className:"material-icons settings text-muted"},b?"expand_less":"expand_more"),"preview"!==i&&l.createElement("div",{className:"dropdown float-right"},l.createElement("i",{className:"material-icons settings text-muted",id:"message-id-"+t.id,"data-toggle":"dropdown","aria-haspopup":"true","aria-expanded":"false"},"more_vert"),l.createElement("div",{className:"dropdown-menu","aria-labelledby":"message-id-"+t.id},p.can_write&&l.createElement("a",{className:"dropdown-item",href:"#",onClick:function(e){e.stopPropagation(),F(!1),P(!0)}},l.createElement("i",{className:"material-icons text-muted"},"reply"),q("msg.reply")),p.can_write&&l.createElement("a",{className:"dropdown-item",href:"#",onClick:function(e){e.stopPropagation(),P(!1),F(!0)}},l.createElement("i",{className:"material-icons text-muted"},"forward"),q("msg.forward")),l.createElement("a",{className:"dropdown-item",target:"_blank",href:WWW_DIR_JAVASCRIPT+"mailconv/mailprint/"+t.id},l.createElement("i",{className:"material-icons text-muted"},"print"),q("mail.print")),l.createElement("a",{className:"dropdown-item",href:WWW_DIR_JAVASCRIPT+"mailconv/apimaildownload/"+t.id},l.createElement("i",{className:"material-icons text-muted"},"cloud_download"),q("msg.download")),p.can_write&&l.createElement("a",{className:"dropdown-item",href:"#",onClick:function(){return s(t)}},l.createElement("i",{className:"material-icons text-muted"},"done"),q("msg.no_reply")),t.alt_body&&l.createElement("a",{className:"dropdown-item",href:"#",onClick:function(e){return A(!I)}},l.createElement("i",{className:"material-icons text-muted"},"visibility"),q("msg.plain_html"))))),b&&l.createElement("div",{className:"col-12"},l.createElement("div",{className:"card"},l.createElement("div",{className:"card-body"},l.createElement("h6",{className:"card-subtitle mb-2 text-muted"},q("msg.info")),l.createElement("div",{className:"row"},l.createElement("div",{className:"col-6"},l.createElement("ul",{className:"fs13 mb-0 list-unstyled"},l.createElement("li",null,l.createElement("span",{className:"text-muted"},q("msg.from"),":")," ",l.createElement("b",null,t.from_name)," <",t.from_address,">"),l.createElement("li",null,l.createElement("span",{className:"text-muted"},q("msg.to"),":")," ",t.to_data_front),t.cc_data_front&&l.createElement("li",null,l.createElement("span",{className:"text-muted"},"cc:")," ",t.cc_data_front),t.bcc_data_front&&l.createElement("li",null,l.createElement("span",{className:"text-muted"},"bcc:")," ",t.bcc_data_front),l.createElement("li",null,l.createElement("span",{className:"text-muted"},q("msg.reply_to"),":")," ",t.reply_to_data_front),l.createElement("li",null,l.createElement("span",{className:"text-muted"},q("msg.mailed_by"),":")," ",t.from_host))),l.createElement("div",{className:"col-6"},l.createElement("ul",{className:"fs13 mb-0 list-unstyled"},t.accept_time_front&&l.createElement("li",null,q("mail.accepted_at"),": ",t.accept_time_front),t.plain_user_name&&l.createElement("li",null,q("mail.accepted_by"),": ",l.createElement("b",null,t.plain_user_name)),t.wait_time&&l.createElement("li",null,q("mail.accept_wait_time"),": ",t.wait_time_pending),t.lr_time&&t.response_time&&l.createElement("li",null,q("mail.response_wait_time"),": ",t.wait_time_response,", ",q("mail.exc_pending_time")),t.lr_time&&l.createElement("li",null,"Response type: ",1==t.response_type?q("msg.nrr"):2==t.response_type?q("msg.orm"):q("msg.rbe")),t.interaction_time&&l.createElement("li",null,q("mail.interaction_time"),": ",t.interaction_time_duration),t.cls_time&&l.createElement("li",null,q("mail.closed_at"),": ",t.cls_time_front),t.conv_duration_front&&l.createElement("li",null,q("mail.response_wait_time"),": ",t.conv_duration_front))))))),k&&t.undelivered&&l.createElement("div",{className:"col-12 alert alert-warning mt-2"},"This message was undelivered. ",l.createElement("a",{href:WWW_DIR_JAVASCRIPT+"mailconv/downloadrfc822/"+t.id},"Download sent message."),l.createElement("div",{className:"text-danger border-bottom my-2 py-2 fs13"},l.createElement("ul",{className:"m-0 pl-3"},t.delivery_status_keyed.Diagnostic_Code&&l.createElement("li",null,t.delivery_status_keyed.Diagnostic_Code),t.delivery_status_keyed.taken&&l.createElement("li",null,t.delivery_status_keyed.taken))),t.delivery_status_keyed&&l.createElement("button",{onClick:function(e){return L(!J)},className:"btn fs12 btn-link"},"Show technical information."),J&&t.delivery_status_keyed&&l.createElement("div",null,l.createElement("pre",null,JSON.stringify(t.delivery_status_keyed,null,2)))),k&&I&&t.alt_body&&l.createElement("div",{className:"col-12 mail-message-body pt-2 pb-2"},l.createElement("pre",{className:"fs12"},t.alt_body)),k&&t.body_front&&!I&&l.createElement("div",{className:"col-12 mail-message-body pt-2 pb-2"},m()(t.body_front,{replace:function(e){if(e.attribs&&(Object.assign({},e.attribs),e.attribs.class&&(e.attribs.className=e.attribs.class,delete e.attribs.class),e.name&&"blockquote"===e.name))return e.attribs.style&&(e.attribs.style=(t=e.attribs.style,a={},t.split(";").forEach((function(e){var t=e.split(":"),r=(0,n.Z)(t,2),l=r[0],s=r[1];if(l){var i=function(e){var t=e.split("-");return 1===t.length?t[0]:t[0]+t.slice(1).map((function(e){return e[0].toUpperCase()+e.slice(1)})).join("")}(l.trim());a[i]=s.trim()}})),a)),l.createElement("blockquote",e.attribs,l.createElement(d,null,(0,o.domToReact)(e.children)));var t,a}}),t.attachments&&t.attachments.length>0&&l.createElement("div",{className:"pt-2"},t.attachments.map((function(e){return l.createElement("a",{className:"btn btn-sm btn-outline-info mr-1",href:e.download_url,title:e.description},e.name)})))),"preview"!==i&&p.can_write&&!v&&(a+1==r||W||T)&&l.createElement(j,{setConversationStatus:_,verifyOwner:g,fetchingMessages:v,fetchMessages:function(e){return f()},moptions:p,forwardMode:T,cancelForward:function(e){return F(!1)},cancelReply:function(e){return P(!1)},replyMode:W,lastMessage:a+1==r,message:t,noReplyRequired:function(){return s(t)}}))};const F=l.memo(T);function M(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function V(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?M(Object(a),!0).forEach((function(t){(0,r.Z)(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):M(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function J(e,t){switch(t.type){case"increment":return{count:e.count+1};case"decrement":case"init":return{count:e.count-1};case"update":return V(V({},e),t.value);case"update_conversation":return e.conv=V(V({},e.conv),t.value),V({},e);case"update_message":var a=e.messages.findIndex((function(e){return e.id==t.message.id}));return e.messages[a]=t.message,t.conv&&(e.conv=t.conv),t.fetching_messages&&(e.fetching_messages=t.fetching_messages),V({},e);case"update_history":return e=V(V({},e),t.value),""!=t.history.msg&&e.messages.unshift(t.history),e;default:throw new Error("Unknown action!")}}const L=function(e){(0,l.useRef)(null),(0,l.useRef)(null);var t=(0,l.useRef)(null),a=(0,l.useReducer)(J,{messages:[],operators:[],conv:null,loaded:!1,saving_remarks:!1,old_message_id:0,last_message:"",remarks:"",last_message_id:0,lmsop:0,lgsync:0,fetching_messages:!1}),r=(0,n.Z)(a,2),s=r[0],o=r[1],m=function(e){i().get(WWW_DIR_JAVASCRIPT+"mailconv/apigetlabels/"+e.id).then((function(e){o({type:"update_message",message:e.data.message})})).catch((function(e){}))},u=function(){i().post(WWW_DIR_JAVASCRIPT+"mailconv/loadmainconv/"+e.chatId+"/(mode)/"+(""!=e.mode?e.mode:"normal")).then((function(t){o({type:"update",value:{conv:t.data.conv,customer_remarks:t.data.customer_remarks,messages:t.data.messages,moptions:t.data.moptions,loaded:!0,fetching_messages:!1}}),!1===e.disableRemember&&"preview"!==e.mode&&function(e){if(localStorage)try{var t=[],a=localStorage.getItem("machat_id");null!==a&&""!==a&&(t=a.split(",")),-1===t.indexOf(e)&&(t.push(e),localStorage.setItem("machat_id",t.join(",")))}catch(e){}}(e.chatId)})).catch((function(t){lhinst.removeDialogTabMail("mc"+e.chatId,$("#tabs"),!0)}))},d=function t(a){i().get(WWW_DIR_JAVASCRIPT+"mailconv/apifetchmails/"+e.chatId+"/"+a).then((function(e){1==e.data.updated?u():setTimeout((function(){return t(a)}),1e3)}))},p=function(e){lhc.revealModal({url:WWW_DIR_JAVASCRIPT+e.url})};(0,l.useEffect)((function(){if(null!==s.conv){var t=setTimeout((function(){i().post(WWW_DIR_JAVASCRIPT+"mailconv/saveremarks/"+e.chatId,{data:s.remarks}).then((function(e){o({type:"update",value:{saving_remarks:!1}})}))}),500);return function(){return clearTimeout(t)}}}),[s.remarks]),(0,l.useEffect)((function(){if(null!==s.conv){var t=setTimeout((function(){i().post(WWW_DIR_JAVASCRIPT+"mailconv/saveremarks/"+e.chatId+"/(type)/customer",{data:s.customer_remarks}).then((function(e){o({type:"update",value:{saving_customer_remarks:!1}})}))}),500);return function(){return clearTimeout(t)}}}),[s.customer_remarks]),(0,l.useEffect)((function(){function t(t){e.chatId==t&&u()}function a(t,a){e.chatId==t&&m({id:a})}return u(),ee.addListener("mailChatModified",t),ee.addListener("mailLabelsModified",a),function(){ee.removeListener("mailChatModified",t),ee.removeListener("mailLabelsModified",a),function(e){if(localStorage)try{var t=[],a=localStorage.getItem("machat_id");null!==a&&""!==a&&(t=a.split(",")),-1!==t.indexOf(e)&&t.splice(t.indexOf(e),1),localStorage.setItem("machat_id",t.join(","))}catch(e){}}(e.chatId)}}),[]),(0,l.useEffect)((function(){1==s.loaded&&(t.current,ee.emitEvent("mailChatContentLoaded",[e.chatId]))}),[s.loaded]);var f=(0,c.$)("mail_chat"),v=f.t;return f.i18n,0==s.loaded?l.createElement("span",null,"..."):l.createElement(l.Fragment,null,l.createElement("div",{className:"row"},l.createElement("div",{className:"chat-main-left-column "+("preview"==e.mode?"col-12":"col-7")},"preview"!==e.mode&&l.createElement("h1",{className:"pb-2"},l.createElement("i",{className:"material-icons"},1==s.conv.start_type?"call_made":"call_received"),s.conv.undelivered&&l.createElement("i",{title:"Undelivered e-mail",className:"text-danger material-icons"},"sms_failed"),s.conv.subject),l.createElement("div",null,s.messages.map((function(t,a){return l.createElement(F,{setConversationStatus:function(e){o({type:"update_conversation",value:{status:e}})},verifyOwner:function(e){e!=s.conv.user_id&&u()},moptions:s.moptions,fetchMessages:function(e){return o({type:"update",value:{fetching_messages:!0}}),void d(Math.floor(Date.now()/1e3))},fetchingMessages:s.fetching_messages,mode:e.mode,key:"msg_mail_"+e.chatId+"_"+a+"_"+t.id,totalMessages:s.messages.length,index:a,message:t,noReplyRequired:function(e){return function(e){i().post(WWW_DIR_JAVASCRIPT+"mailconv/apinoreplyrequired/"+e.id).then((function(e){o({type:"update_message",message:e.data.message,conv:e.data.conv})})).catch((function(e){}))}(t)},addLabel:function(e){return function(e){lhc.revealModal({url:WWW_DIR_JAVASCRIPT+"mailconv/apilabelmessage/"+e.id,hidecallback:function(){m(e)}})}(t)}})})),s.fetching_messages&&l.createElement("div",{className:"alert alert-success p-1 pl-2",role:"alert"},v("mail.send_fetching")))),l.createElement("div",{className:"chat-main-right-column "+("preview"==e.mode?"d-none":"col-5")},l.createElement("div",{role:"tabpanel"},l.createElement("ul",{className:"nav nav-pills",role:"tablist",ref:t},l.createElement("li",{role:"presentation",className:"nav-item"},l.createElement("a",{className:"nav-link active",href:"#mail-chat-info-"+e.chatId,"aria-controls":"#mail-chat-info-"+e.chatId,title:v("mail.information"),role:"tab","data-toggle":"tab"},l.createElement("i",{className:"material-icons mr-0"},"info_outline"))),l.createElement("li",{role:"presentation",className:"nav-item"},l.createElement("a",{className:"nav-link",href:"#mail-chat-remarks-"+e.chatId,"aria-controls":"#mail-chat-remarks-"+e.chatId,role:"tab","data-toggle":"tab",title:v("mail.remarks")},l.createElement("i",{className:"material-icons mr-0"},"mode_edit")))),l.createElement("div",{className:"tab-content"},l.createElement("div",{role:"tabpanel",className:"tab-pane",id:"mail-chat-remarks-"+e.chatId},l.createElement("div",{className:"pb-1 text-success"+(s.saving_customer_remarks?" text-warning":"")},l.createElement("span",{className:"material-icons"},"mode_edit")," Customer remarks"),l.createElement("div",null,l.createElement("textarea",{disabled:!s.moptions.can_write,placeholder:"Enter your remarks here.",onKeyUp:function(e){return t=e.target.value,void o({type:"update",value:{saving_customer_remarks:!0,customer_remarks:t}});var t},className:"form-control mh150",defaultValue:s.customer_remarks})),l.createElement("div",{className:"pb-1 text-success"+(s.saving_remarks?" text-warning":"")},l.createElement("span",{className:"material-icons"},"mode_edit")," Conversation remarks"),l.createElement("div",null,s.conv&&l.createElement("textarea",{disabled:!s.moptions.can_write,placeholder:"Enter your remarks here.",onKeyUp:function(e){return t=e.target.value,void o({type:"update",value:{saving_remarks:!0,remarks:t}});var t},class:"form-control mh150",defaultValue:s.conv.remarks}))),l.createElement("div",{role:"tabpanel",className:"tab-pane active",id:"mail-chat-info-"+e.chatId},s.moptions.can_write&&l.createElement("div",{className:"pb-2"},l.createElement("a",{className:"btn btn-outline-secondary btn-sm",onClick:function(){return e=!1,s.messages.forEach((function(t){2!=t.status&&(e=!0)})),void((0==e||confirm("There is still unresponded messages, are you sure you want to close this conversation?"))&&i().post(WWW_DIR_JAVASCRIPT+"mailconv/apicloseconversation/"+s.conv.id).then((function(e){o({type:"update",value:{conv:e.data.conv,messages:e.data.messages}}),document.getElementById("chat-tab-link-mc"+s.conv.id)&&lhinst.removeDialogTabMail("mc"+s.conv.id,$("#tabs"),!0)})).catch((function(e){})));var e}},l.createElement("i",{className:"material-icons"},"close"),v("mail.close"))),l.createElement("div",{id:"mail-external-details-"+e.chatId}),s.conv&&l.createElement("table",{className:"table table-sm"},l.createElement("tr",null,l.createElement("td",{colSpan:"2"},l.createElement("div",{className:"row"},l.createElement("div",{className:"col-6"},l.createElement("span",{className:"action-image",onClick:function(){return p({url:"mailconv/mailhistory/"+e.chatId})}},l.createElement("i",{className:"material-icons"},"history"),v("mail.interactions_history"))),s.moptions.can_write&&l.createElement("div",{className:"col-6"},l.createElement("span",{className:"action-image",onClick:function(){return p({url:"mailconv/transfermail/"+e.chatId})}},l.createElement("i",{className:"material-icons"},"supervisor_account"),v("mail.transfer_chat"))),l.createElement("div",{className:"col-6"},l.createElement("a",{className:"text-dark",target:"_blank",href:WWW_DIR_JAVASCRIPT+"mailconv/mailprintcovnersation/"+e.chatId},l.createElement("i",{className:"material-icons"},"print"),v("mail.print"))),s.moptions.can_write&&s.conv.can_delete&&l.createElement("div",{className:"col-6"},l.createElement("span",{className:"action-image mr-0",onClick:function(e){confirm("Are you sure?")&&i().post(WWW_DIR_JAVASCRIPT+"mailconv/apideleteconversation/"+s.conv.id).then((function(e){document.getElementById("chat-tab-link-mc"+s.conv.id)?lhinst.removeDialogTabMail("mc"+s.conv.id,$("#tabs"),!0):document.location=WWW_DIR_JAVASCRIPT+"mailconv/conversations"})).catch((function(e){}))}},l.createElement("i",{className:"material-icons"},"delete"),v("mail.delete")))))),l.createElement("tr",null,l.createElement("td",null,v("mail.sender")),l.createElement("td",null,s.conv.from_name," <",s.conv.from_address,">")),l.createElement("tr",null,l.createElement("td",null,v("mail.status")),l.createElement("td",null,!s.conv.status&&l.createElement("span",null,l.createElement("i",{className:"material-icons chat-pending"},"mail_outline"),v("status.pending")),1==s.conv.status&&l.createElement("span",null,l.createElement("i",{className:"material-icons chat-active"},"mail_outline"),v("status.active")),2==s.conv.status&&l.createElement("span",null,l.createElement("i",{className:"material-icons chat-closed"},"mail_outline"),v("status.closed")))),l.createElement("tr",null,l.createElement("td",null,v("mail.department")),l.createElement("td",null,l.createElement("span",{title:s.conv.dep_id},s.conv.department_name),", ",l.createElement("span",{title:s.conv.mailbox_id},s.conv.mailbox_front.name," (",s.conv.mailbox_front.mail,")"))),l.createElement("tr",null,l.createElement("td",null,v("mail.received")),l.createElement("td",null,s.conv.udate_front)),l.createElement("tr",null,l.createElement("td",null,"ID"),l.createElement("td",null,s.conv.id," ",s.conv.follow_up_id&&l.createElement("a",{target:"_blank",href:WWW_DIR_JAVASCRIPT+"mailconv/view/"+s.conv.follow_up_id},l.createElement("span",{className:"material-icons"},"launch"),"Follow up of ",s.conv.follow_up_id))),s.conv.accept_time&&l.createElement("tr",null,l.createElement("td",null,v("mail.last_accepted_at")),l.createElement("td",null,s.conv.accept_time_front,s.conv.wait_time_pending&&l.createElement(l.Fragment,null," | Wait time ",s.conv.wait_time_pending))),s.conv.response_time&&l.createElement("tr",null,l.createElement("td",null,v("mail.last_responded_at")),l.createElement("td",null,s.conv.lr_time_front,s.conv.wait_time_response&&l.createElement(l.Fragment,null," | Wait time ",s.conv.wait_time_response))),s.conv.cls_time&&l.createElement("tr",null,l.createElement("td",null,v("mail.closed_at")),l.createElement("td",null,s.conv.cls_time_front)),s.conv.conv_duration&&l.createElement("tr",null,l.createElement("td",null,v("mail.conv_duration")),l.createElement("td",null,s.conv.conv_duration_front)),s.conv.interaction_time&&l.createElement("tr",null,l.createElement("td",null,v("mail.last_interaction_time")),l.createElement("td",null,s.conv.interaction_time_duration)),s.conv.priority&&l.createElement("tr",null,l.createElement("td",null,v("mail.priority")),l.createElement("td",null,s.conv.priority)),l.createElement("tr",null,l.createElement("td",{title:s.conv.user_id},v("mail.chat_owner")),l.createElement("td",null,s.conv.plain_user_name)))))))))}}}]);
//# sourceMappingURL=653.e7e0b350ebd45f4f0cd7.js.map